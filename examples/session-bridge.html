<!DOCTYPE html>
<html>
<head>
    <title>GunAuth Session Bridge</title>
    <meta charset="utf-8">
</head>
<body>
    <script>
        // This file should be hosted on your auth domain
        // It handles postMessage communication for cross-domain session sharing
        
        class SessionBridge {
            constructor() {
                window.addEventListener('message', this.handleMessage.bind(this));
                console.log('GunAuth Session Bridge loaded');
            }

            handleMessage(event) {
                // Verify trusted origins
                const trustedOrigins = [
                    'https://app1.example.com',
                    'https://app2.example.com',
                    'http://localhost:8001',
                    'http://localhost:8002',
                    'http://localhost:3001',
                    'http://localhost:3002'
                ];

                if (!trustedOrigins.some(origin => event.origin.startsWith(origin))) {
                    console.warn('Untrusted origin:', event.origin);
                    return;
                }

                const { type, action, messageId, data } = event.data;

                if (type === 'gunauth-request') {
                    this.handleRequest(event, action, messageId, data);
                }
            }

            async handleRequest(event, action, messageId, data) {
                try {
                    let result;

                    switch (action) {
                        case 'getSession':
                            result = this.getSession();
                            break;
                        case 'setSession':
                            result = this.setSession(data);
                            break;
                        case 'clearSession':
                            result = this.clearSession();
                            break;
                        case 'verifyToken':
                            result = await this.verifyToken(data);
                            break;
                        default:
                            throw new Error(`Unknown action: ${action}`);
                    }

                    event.source.postMessage({
                        type: 'gunauth-response',
                        messageId,
                        data: result
                    }, event.origin);

                } catch (error) {
                    event.source.postMessage({
                        type: 'gunauth-response',
                        messageId,
                        error: error.message
                    }, event.origin);
                }
            }

            getSession() {
                const token = localStorage.getItem('gunauth_token');
                const pub = localStorage.getItem('gunauth_pub');

                if (token && pub) {
                    return { token, pub };
                }

                return null;
            }

            setSession(sessionData) {
                if (sessionData && sessionData.token && sessionData.pub) {
                    localStorage.setItem('gunauth_token', sessionData.token);
                    localStorage.setItem('gunauth_pub', sessionData.pub);
                    return true;
                }
                return false;
            }

            clearSession() {
                localStorage.removeItem('gunauth_token');
                localStorage.removeItem('gunauth_pub');
                return true;
            }

            async verifyToken(data) {
                const authServerUrl = 'http://localhost:8000'; // Configure this

                try {
                    const response = await fetch(`${authServerUrl}/verify`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();
                    return result;
                } catch (error) {
                    throw new Error(`Token verification failed: ${error.message}`);
                }
            }
        }

        // Initialize the bridge
        new SessionBridge();
    </script>
</body>
</html>
